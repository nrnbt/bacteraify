{% load static %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>

<script type="text/javascript">
  var survey_number = ""
  downloadPdf = (resultFileName) => {
    const test = window.location.href.includes('test')
    if(test){
      const idx = '{{ index }}'
      var url = `{% url 'download-test-survey' %}?result=${idx}`
    } else {
      var url = `{% url 'download-survey' %}?result=${resultFileName}`
    }
    btn = document.getElementById('loadingButton')
    btn.classList.add('loading');
    fetch(url)
      .then(response => {
        if (!response.ok) {
            throw new Error('Network error')
        }
        return response.json()
      })
      .then(data => {
          survey_number = data.survey_number
          generatePDF(data.resp_data)
      })
      .catch(error => {
        btn = document.getElementById('loadingButton')
        btn.classList.remove('loading');
        console.error('There has been a problem with your fetch operation:', error)
      })
  }
  formatDate = (date) => {
    var year = date.getFullYear();
    var month = ('0' + (date.getMonth() + 1)).slice(-2);
    var day = ('0' + date.getDate()).slice(-2);
    var hours = ('0' + date.getHours()).slice(-2);
    var minutes = ('0' + date.getMinutes()).slice(-2);
    var seconds = ('0' + date.getSeconds()).slice(-2);
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }
  generatePDF = (htmlContent) => {
    const hiddenContainer = document.getElementById('hiddenContainer')
    hiddenContainer.innerHTML = htmlContent
    var downloaded_at = document.getElementById('downloaded_at')
    var formattedDate = formatDate(new Date())
    downloaded_at.innerHTML =  "<strong>ХЭВЛЭСЭН ОГНОО:</strong> " + formattedDate
    const jsPDF = window.jspdf.jsPDF
    const hiddenContent = document.getElementById('hiddenContainer')
    hiddenContent.style.display = 'block'
    const pdf = new jsPDF({
      format: 'a4',
      orientation: 'portrait' 
    })
    html2canvas(hiddenContent,{
      scale: Math.min(2480 / hiddenContent.offsetWidth, 3508 / hiddenContent.offsetHeight)
    }).then((hiddenCanvas) => {
      const hiddenImgData = hiddenCanvas.toDataURL('image/png')
      const pdfWidth = pdf.internal.pageSize.getWidth()
      const pdfHeight = pdf.internal.pageSize.getHeight()
      const imgProps = pdf.getImageProperties(hiddenImgData)
      const pdfImageWidth = pdfWidth
      const pdfImageHeight = (imgProps.height * pdfImageWidth) / imgProps.width

      let heightLeft = pdfImageHeight;
      let position = 0;
      heightLeft -= pdfHeight;
      pdf.addImage(hiddenImgData, 'PNG', 10, 10, pdfImageWidth - 20, pdfImageHeight)
      while (heightLeft >= 0) {
        position = heightLeft - pdfImageHeight;
        pdf.addPage();
        pdf.addImage(hiddenCanvas, 'PNG', 10, position, pdfImageWidth - 20, pdfImageHeight);
        heightLeft -= pdfHeight;
      }
      btn = document.getElementById('loadingButton')
      btn.classList.remove('loading');
      pdf.save(survey_number + ".pdf")
    })
  }
</script>

<div style="max-width: 780px;" class="w-full flex flex-col">
  <table class="table table-striped w-full">
    <thead>
      <tr>
        <th style="vertical-align: middle" scope="col" class="bg-primary text-white text-center">Бактери нэршил</th>
        {% for columns in result_data.0.keys %}
          {% if columns == 'CNN' %}
            <th style="vertical-align: middle" scope="col" class="bg-primary text-white text-center">Илэрсэн хувь (CNN)</th>
          {% elif columns == 'SVM'  %}
            <th style="vertical-align: middle" scope="col" class="bg-primary text-white text-center">Илэрсэн хувь (SVM)</th>
          {% elif columns == 'RNN'  %}
            <th style="vertical-align: middle" scope="col" class="bg-primary text-white text-center">Илэрсэн хувь (RNN)</th>
          {% endif  %}
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in result_data %}
        <tr>
          <td class="text-center">
            <div class="d-flex justify-content-center gap-2 align-items-center">
              {{ row.bacteria }}
              <img style="height: 45px; object-fit: contain;" src="{% static 'images/bacteria/' %}{{row.bacteria}}.png" alt="{{ row.bacteria }}">
            </div>
          </td>
          {% for columns in result_data.0.keys %}
            {% if columns == 'CNN' %}
              <td class="text-center">
                <div class="d-flex justify-content-center gap-2 align-items-center" style="height: 45px">{{ row.CNN }}</div>
              </td>
            {% elif columns == 'SVM'  %}
              <td class="text-center">
                <div class="d-flex justify-content-center gap-2 align-items-center" style="height: 45px">{{ row.SVM }}</div>
              </td>
            {% elif columns == 'RNN'  %}
              <td class="text-center">
                <div class="d-flex justify-content-center gap-2 align-items-center" style="height: 45px">{{ row.RNN }}</div>
              </td>
            {% endif  %}
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <button id="loadingButton" class="btn button bg-primary" type="submit" onclick="downloadPdf('{{ request.GET.id|urlencode }}')">
    <a class="h-full text-white" href="#">
      <i class="fas fa-file-pdf text-lg me-1"></i>Шинжилгээний хариу татах
    </a>
  </button>
  <div class="result-chart">
    {% include 'charts/bar-chart.html' %}
  </div>
</div>
<div id="hiddenContainer" style="max-width: 1280px; width: 100%"></div>