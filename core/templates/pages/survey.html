{% extends 'layouts/main.html' %}
{% load static %}

{% block user-content %}
  {% if request.path == '/survey/load/' %}
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      const toaster = document.querySelector('.toaster')
  
      function showError() {
        toaster.classList.add('show')
        setTimeout(() => {
          toaster.classList.remove('show')
        }, 2900);
      }
  
      try {
        const url = window.location.href
        const hasPath = url.includes('/survey/load/')
        const queryParams = new URLSearchParams(window.location.search)
        const hasQueryParam = queryParams.has('file_name')

        if (hasPath && hasQueryParam) {
          const socketPort = '{{ SOCKET_PORT }}' ?? '8001'
          const socketUrl = `ws://${window.location.hostname}:${socketPort}/ws/task/`
  
          const socket = new WebSocket(socketUrl)
  
          socket.onmessage = (e) => {
            try {
              const data = JSON.parse(e.data)
              if (data && data.file_name) {
                const currentUrl = window.location.href
                const baseUrl = currentUrl.split('/survey/')[0]
                const newUrl = baseUrl + '/survey/result/?file_name=' + data.file_name
                window.location.href = newUrl
              }
            } catch (err) {
              console.error('Error processing message:', err);
              showError()
            }
          }
  
          socket.onerror = (e) => {
            console.error('WebSocket error:', e);
            showError()
          };
        }
      } catch (error) {
        console.error('Error:', error)
        showError()
      }
    })
  </script>
  {% endif %}

  <div class="stepper-wrapper">
    <div class="step {% if request.path == '/survey/' %}active{% else %} completed {% endif %}">
      <div class="step-img-wrapper">
        <img class="step-img" src="{% static 'images/icon-images/step1.png' %}" alt="step1">
      </div>
      <div class="step-icon">
        {% if request.path != '/survey/' %}
          <i class="fa-solid fa-check" style="color:#fff;"></i>
        {% endif %}
      </div>
      <div class="step-title">Сорьц оруулах</div>
    </div>
    <div class="step-line"></div>
    <div class="step {% if request.path == '/survey/' or request.path == '/survey/upload/' %} incomplete {% elif request.path == '/survey/load/' %} loading {% else %} completed {% endif %}">
      <div class="step-img-wrapper">
        <img class="step-img" src="{% static 'images/icon-images/step2.png' %}" alt="step2">
      </div>
      <div class="step-icon">
        {% if request.path != '/survey/' and request.path != '/survey/upload/' and request.path != '/survey/load/'  %}
          <i class="fa-solid fa-check" style="color:#fff;"></i>
        {% endif %}
      </div>
      <div class="step-title">Бактери таних</div>
    </div>
    <div class="step-line"></div>
    <div class="step {% if request.path == '/survey/' or request.path == '/survey/upload/' or request.path == '/survey/load/' %} incomplete {% elif request.path == '/survey/finish/' %} completed {% else %} active {% endif %}">
      <div class="step-img-wrapper">
        <img class="step-img" src="{% static 'images/icon-images/step3.png' %}" alt="step3">
      </div>
      <div class="step-icon">
        {% if request.path != '/survey/' and request.path != '/survey/upload/' and request.path != '/survey/load/' and request.path != '/survey/result/' %}
          <i class="fa-solid fa-check" style="color:#fff;"></i>
        {% endif %}
      </div>
      <div class="step-title">Хариу авах</div>
    </div>
  </div>
  {% if request.path == '/survey/' or request.path == '/survey/upload/' %}
  {% include 'components/file-upload-form.html' %}
  {% elif '/survey/load/' in request.path %}
  <div style="max-width: 390px; width: 100%;">
    {% include 'components/ai-loader.html' %}
  </div>
  {% else %}
  <div style="max-width: 780px;" class="w-full flex flex-col">
    <table class="table table-striped w-full">
      <thead>
        <tr>
          <th scope="col" class="bg-primary text-white text-center">Бактери нэршил</th>
          <th scope="col" class="bg-primary text-white text-center">Илэрсэн хувь</th>
        </tr>
      </thead>
      <tbody>
        {% for key, value in result_data.items %}
          <tr>
            <td class="text-center">{{ key }}</td>
            <td class="text-center">{{ value }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <button class="btn button bg-primary" type="submit">
      <script type="text/javascript">
        downloadFile = (path) => {
          window.location.href = path
        }
      </script>
      <a 
        class="h-full w-full text-white font-semibold" 
        href="#"
        onclick="downloadFile('{% url 'download-survey' %}?result={{ request.GET.file_name|urlencode }}')"
      >
        татах
      </a>
    </button>
    <div class="m-5">
      {% include 'charts/bar-chart.html' %}
    </div>
  </div>
  {% endif %}
{% endblock user-content %}